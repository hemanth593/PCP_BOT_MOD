<!DOCTYPE html>
<html>
<head>
<title>Findimage (Lua) — UoPilot</title>
<meta charset="UTF-8" />
<link rel="stylesheet" href="styles" />
</head>
<body>
<h1 id="firstHeading" class="firstHeading" lang="ru">Findimage (Lua)</h1>
	
	<h2><span id="Описание"></span><span class="mw-headline" id=".D0.9E.D0.BF.D0.B8.D1.81.D0.B0.D0.BD.D0.B8.D0.B5">Описание</span></h2>
<p><b>findimage</b> - поиск изображения в области заданной начальными и конечными координатами по оси XY. 
<br />
<br />Формат картинки должен быть: <b>bmp 24 бита.</b> <br />Цвет крайнего пикселя в левом верхнем углу изображения считается "цветом фона", и при поиске картинки на экране не учитывается. Например, цвет этого пикселя красный (255). В этом случае все пиксели красного цвета присутствующие на искомой картинке будут считаться фоновыми (прозрачными) и не будут сравниваться с тем, что присутствует на экране. Поэтому, нельзя чтобы в файле-картинке все пиксели были одного цвета. Нужно сделать, чтобы хотя бы один левый верхний пиксель цветом отличался от остальных.
</p>
<h2><span id="Синтаксис"></span><span class="mw-headline" id=".D0.A1.D0.B8.D0.BD.D1.82.D0.B0.D0.BA.D1.81.D0.B8.D1.81">Синтаксис</span></h2>
<p>Привязка к окну: опционально.
<br />Работа со свернутым окном: нет.
<br />Работа с перекрытым окном: Да. Привязка к окну обязательна. Aero (темы Windows, кроме Windows 10, в котором нет aero) должен быть включен. Если был установлен Астер, то он должен быть отключен, а система перезагружена.
</p>
<pre>ResultArray, a = findimage (&lt;StartX&gt;, &lt;StartY&gt;, &lt;EndX&gt;, &lt;EndY&gt;, &lt;{filename}&gt;  [, type [, accuracy [, count [, deviation]]]] [, abs])
</pre>
<p>Где:
<br /><b>ResultArray</b> - результирующий массив, в который записываются координаты изображения. Координатами изображения считается пиксель левого верхнего угла изображения. Если найдено несколько изображений, то координаты всех найденных изображений. Каждая строка массива хранится данные по отдельному найденному изображению: в первой колонке- координата X, во второй колонке- координата Y.
<br /><b>&lt;a&gt;</b> - переменная, в которую записывается результат работы команды findimage:
<br />Если a = 0, значит поиск был произведён, но картинка не найдена.
<br />Если найдена только 1 картинка, то будет записан процент точности найденного изображения.
<br />Если найдено несколько картинок, то будет записано количество найденных изображений.
<br />Однозначно определить сколько именно картинок было найдено командой FindImage лучше всего по размеру массива ResultArray с помощью функции #ResultArray.
<br />a &lt; 0 означает, что FindImage не смог произвести поиск- либо была обнаружена ошибка в написании параметров команды, либо проблемы с самим файлом картинки.
<br />Если a = -4, значит файл картинки не найден / в неправильном формате / повреждён / все пиксели файла одного цвета. Чаще всего- путь к файлу указан неправильно.
<br /><b>StartX, StartY</b> - координаты левого верхнего угла области поиска.
<br /><b>EndX, EndY</b> - координаты правого нижнего угла области поиска.
<br /><b>{filename}</b> - путь к сохранённому изображению (только файл формата bmp 24 бита). Путь к изображению может быть указан как <b>абсолютный</b> - {C:\\programms\\pilot\\images\\}, так <b>и относительный</b> - {images\\}. Указывается в фигурных скобках.
<br /><b>type</b> - тип поиска. Может принимать значения: <b>1</b> (надежный), <b>2</b> (быстрый), <b>workwindow</b>(поиск в окне, в том числе перекрытом). Настоятельно рекомендуется использовать быстрый способ поиска, кроме случаев с некорректным обнаружением изображения. По умолчанию 2й тип поиска. Тип workwindow - в качестве аргумента указывать хендл окна.
<br /><b>accuracy</b> - точность поиска. Указывается в процентах. Используется для отсева изображений не достаточно схожих с оригиналом. По умолчанию значение равно 80%.
<br /><b>count</b> - ограничение количества найденных изображений. По умолчанию установлено для одного изображения - значение <b>1</b>, для всех возможных - значение <b>-1</b>. 
<br /><b>deviation</b> - погрешность оттенка. Пример: есть погрешность 3%. Точка имеет цвет 100 120 130, 255*3%=7, соответственно 100+/-7. При этом все цвета в пределах (93 113 123)-(107 127 137) будут считаться совпадением. 
<br /><b>abs</b> - флаг использования абсолютных координат. Если он указан то поиск происходит относительно левого верхнего угла экрана. Без флага поиск происходит относительно левого верхнего угла рабочего окна(привязанного через ctrl+a либо иным способом). Указывается в кавычках "abs".
<br />
<br />Если вы ищете на экране текст в виде картинки, и в системе используется сглаживание шрифтов, то могут быть проблемы с нахождением, даже если вы видите, что такой текст на экране есть. Все-равно при включенном сглаживании искомая картинка может незначительно отличаться от того что есть на экране. В этом случае рекомендуется снизить точность поиска либо отключить сглаживание шрифтов на компьютере, где используется findimage.
</p><p><b>Коды ошибок FindImage:</b><br />
'<b>-1'</b> упало при поиске, точная причина не известна.<br />
'<b>-2'</b> не нашли открывающую скобку после имени функции.<br />
'<b>-3'</b> не найдено пути в скобках.<br />
'<b>-4'</b>  ошибка поиска файла.<br />
'<b>-5'</b> ошибка обработки искомого изображения.<br />
'<b>-6'</b> ошибка получения изображения с экрана.<br />
'<b>-7'</b> нечего искать, искомая картинка пустая.
<br /><br />Иногда требуется сделать клик не по самому изображению, а со смещением. Указывать можно как вначале скрипта так и перед функцией findimage.
</p>
<pre>findoffsetx (50)    -- смещение вправо на 50 пикселей
findoffsety (30)    -- смещение вниз на 30 пикселей

findoffsetx (-40)   -- смещение влево на 40 пикселей
findoffsety (-60)   -- смещение вверх на 60 пикселей
</pre>
<h2><span id="Примеры"></span><span class="mw-headline" id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80.D1.8B">Примеры</span></h2>
<pre>--lua
local startX, startY, endX, endY = 0, 0, 1920, 1080   -- координаты поиска 
local path = [["C:\картинка.bmp"]]                   -- путь к картинке, bmp 24 бита
local arr, a = findimage (startX, startY, endX, endY, {path}, 2)  -- поиск картинки
hint (a)     -- результат поиска, подсказка в правом нижнем углу
if arr then  -- если найдена
    log ("Изображение найдено в координатах X= " .. arr[1][1] .. " Y= " .. arr[1][2])
    kleft (arr[1][1], arr[1][2])  -- кликнули
end
-- в результате работы, если в заданной области картинка обнаружена, в массив %arr[1][1] будет записано значение координаты X
-- а в %arr[1][2] - значение координаты Y
</pre>
<pre>--lua
-- поиск нескольких одинаковых изображений
-- если будет найдено больше 20 поиск прекратится, точность 70%, отклонение в цвете 5%
local arr, a = findimage (0, 0, 1920, 1080, {"картинка.bmp"}, 2, 70, 20, 5)  -- поиск картинки, должна быть в папке с пилотом
hint (a)     -- результат поиска, подсказка в правом нижнем углу
if arr then  -- если найдена
    log ("Найдено картинок: " .. #arr)
    for i=1, #arr do
        kleft (arr[i][1], arr[i][2])  -- кликнули на каждой
        wait (1000)  -- пауза 1000 мсек (1 сек)
    end 
end
</pre>
<pre>--lua
local startX, startY, endX, endY = 0, 0, 1920, 1080   -- координаты поиска
local path = [[C:\pilot]]                    -- путь к картинкам

local image = {"картинка", "картинка2", "картинка3"}   -- массив с именами картинок, имена могут быть любыми
hint ("Всего картинок для поиска " .. #image)
for i=1, #image do                     -- цикл для поиска картинок
    local arr, a = findimage (startX, startY, endX, endY, {path .. "\\" .. image[i] .. ".bmp"}, 2)  -- поиск картинки
    if  arr then
        move (arr[1][1], arr[1][2])    -- переместить курсор на найденную картинку
        wait (500)                     -- ждать 0,5 секунды
    end
end
</pre>
<p><b>Пример поиска картинки в перекрытом(не свёрнутом) окне:</b>
<br />Привязка к окну обязательна. Aero (темы Windows 7) должен быть включен. Если был установлен Астер, то он должен быть отключен, а система перезагружена.
<br />Окно может быть перекрыто полностью, частично или вообще не перекрыто. Может находиться за пределами экрана.
<br />Как правило, требуется указывать родительское окно. В окне пилота есть кнопка 'F', при нажатии открывается окно, в котором отображается что "видит" пилот при поиске (Findcolor, Findimage). 
</p>
<pre>--lua
local handle = findwindow ("Lineage2")   -- поиск окна, вместо 'Lineage2' написать нужное имя окна
local startX, startY, endX, endY = 0, 0, 1920, 1080   -- координаты поиска
local path = [["C:\картинка.bmp"]]                    -- путь к картинке
if handle then
    local arr, a = findimage (startX, startY, endX, endY, {path}, handle[1][1])  -- поиск картинки
    hint (a)     -- результат поиска, подсказка в правом нижнем углу
    if arr then  -- если найдена
        log ("Изображение найдено в координатах X= " .. arr[1][1] .. " Y= " .. arr[1][2])
        left (arr[1][1], arr[1][2], handle[1][1])  -- кликнули, left работает не во всех приложениях
        -- move (arr[1][1], arr[1][2], handle[1][1])  -- навести курсор на картинку (раскомментировать строку чтобы сработало)
    else
        log ("Изображение не найдено")
    end
else
    log("Окно не найдено")
end
</pre>
<h2><span id="Смотрите_также"></span><span class="mw-headline" id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5">Смотрите также</span></h2>
<p><a href="Findcolor_(Lua)&amp;action=edit&amp;redlink=1.htm" class="new" title="Findcolor (Lua) (страница не существует)">Findcolor (Lua)</a>
<br /><a href="https://uopilot.uokit.com/wiki/index.php?title=Color_(Lua)" title="Color (Lua)">Color (Lua)</a>
</p>





		
		
		
		<div id="catlinks" class="catlinks catlinks-allhidden" data-mw="interface"></div>
		
		<div class="visualClear"></div>
		
	</div>
</div>

		
<br>
<div class="printfooter">Источник — <a dir="ltr" href="https://uopilot.uokit.com/wiki/index.php?title=Findimage_(Lua)&amp;oldid=871">https://uopilot.uokit.com/wiki/index.php?title=Findimage_(Lua)&amp;oldid=871</a></div></body>
</html>
 