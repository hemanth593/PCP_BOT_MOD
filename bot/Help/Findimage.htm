<!DOCTYPE html>
<html>
<head>
<title>Findimage — UoPilot</title>
<meta charset="UTF-8" />
<link rel="stylesheet" href="styles" />
</head>
<body>
<h1 id="firstHeading" class="firstHeading" lang="ru">Findimage</h1>
	
	<h2><span id="Описание"></span><span class="mw-headline" id=".D0.9E.D0.BF.D0.B8.D1.81.D0.B0.D0.BD.D0.B8.D0.B5">Описание</span></h2>
<p><b>FindImage</b> - оператор поиска сохраненного изображения в области заданной начальными и конечными координатами по оси XY.
<br />
<br />Формат картинки должен быть: <b>bmp 24 бита.</b> <br />Цвет крайнего пикселя в левом верхнем углу изображения считается "цветом фона", и при поиске картинки на экране не учитывается. Например, цвет этого пикселя красный (255). В этом случае все пиксели красного цвета присутствующие на искомой картинке будут считаться фоновыми (прозрачными) и не будут сравниваться с тем, что присутствует на экране. Поэтому, нельзя чтобы в файле-картинке все пиксели были одного цвета. Нужно сделать, чтобы хотя бы один левый верхний пиксель цветом отличался от остальных.
</p>
<h2><span id="Синтаксис"></span><span class="mw-headline" id=".D0.A1.D0.B8.D0.BD.D1.82.D0.B0.D0.BA.D1.81.D0.B8.D1.81">Синтаксис</span></h2>
<p>Привязка к окну: опционально.
<br />Работа со свернутым окном: нет.
<br />Работа с перекрытым окном: Да. Привязка к окну обязательна. Aero (темы Windows) должен быть включен. Если был установлен Астер, то он должен быть отключен, а система перезагружена.
</p>
<pre>set #a FindImage (#StartX #StartY #EndX #EndY ($filename) %ResultArray [#type [#accuracy [#count [#deviation]]]] [abs])
</pre>
<p>Где:
<br /><b>&lt;#a&gt;</b> - переменная, в которую записывается результат работы команды findimage:
<br />Если #a = 0, значит поиск был произведён, но картинка не найдена.
<br />Если найдена только 1 картинка, то будет записан процент точности найденного изображения.
<br />Если найдено несколько картинок, то будет записано количество найденных изображений.
<br />Однозначно определить сколько именно картинок было найдено командой FindImage лучше всего по размеру массива %ResultArray с помощью функции Size(%ResultArray).
<br />#a &lt; 0 означает, что FindImage не смог произвести поиск- либо была обнаружена ошибка в написании параметров команды, либо проблемы с самим файлом картинки.
<br />Если #a = -4, значит файл картинки не найден / в неправильном формате / повреждён / все пиксели файла одного цвета. Чаще всего- путь к файлу указан неправильно.
<br /><b>&lt;#StartX #StartY&gt;</b> - координаты левого верхнего угла области поиска.
<br /><b>&lt;#EndX #EndY&gt;</b> - координаты правого нижнего угла области поиска.
<br /><b>&lt;($filename)&gt;</b> - путь к сохранённому изображению (только файл формата bmp). Путь к изображению может быть указан как <b>абсолютный</b> - (C:\programms\pilot\images\), так <b>и относительный</b> - (images\). Указывается в круглых скобках. При использовании пробелов в адресе используйте кавычки либо строковую переменную(например $myPatch), предварительно присвоив ей(переменной) необходимый адрес.
<br /><b>&lt;%ResultArray&gt;</b> - результирующий массив, в который записываются координаты изображения. Координатами изображения считается пиксель левого верхнего угла изображения. Если найдено несколько изображений, то координаты всех найденных изображений. Каждая строка массива хранится данные по отдельному найденному изображению: в первой колонке- координата X, во второй колонке- координата Y.
<br /><b>[#type]</b> - тип поиска. Может принимать значения: <b>1</b> (надежный), <b>2</b> (быстрый). Настоятельно рекомендуется использовать быстрый способ поиска, кроме случаев с некорректным обнаружением изображения. По умолчанию 2й тип поиска.
<br /><b>[#accuracy]</b> - точность поиска. Указывается в процентах. Используется для отсева изображений не достаточно схожих с оригиналом. По умолчанию значение равно 80%.
<br /><b>[#count]</b> - ограничение количества найденных изображений. По умолчанию установлено для одного изображения - значение <b>1</b>, для всех возможных - значение <b>-1</b>. 
<br /><b>[#deviation]</b> - Погрешность оттенка. Пример: есть погрешность 3%. точка имеет цвет 100 120 130, 255*3%=7, соответственно 100+/-7. При этом все цвета в пределах (93 113 123)-(107 127 137) будут считаться совпадением. 
<br /><b>[abs]</b> - флаг использования абсолютных координат. Если он указан то поиск происходит относительно левого верхнего угла экрана. Без флага поиск происходит относительно левого верхнего угла рабочего окна(привязанного через ctrl+a либо иным способом).
<br />
<br />Если вы ищете на экране текст в виде картинки, и в системе используется сглаживание шрифтов, то могут быть проблемы с нахождением, даже если вы видите, что такой текст на экране есть. Все-равно при включенном сглаживании искомая картинка может незначительно отличаться от того что есть на экране. В этом случае рекомендуется снизить точность поиска либо отключить сглаживание шрифтов на компьютере, где используется findimage.
</p><p><b>Коды ошибок FindImage:</b><br />
'<b>-1'</b> упало при поиске, точная причина не известна.<br />
'<b>-2'</b> не нашли открывающую скобку после имени функции.<br />
'<b>-3'</b> не найдено пути в скобках.<br />
'<b>-4'</b>  ошибка поиска файла.<br />
'<b>-5'</b> ошибка обработки искомого изображения.<br />
'<b>-6'</b> ошибка получения изображения с экрана.<br />
'<b>-7'</b> нечего искать, искомая картинка пустая.
<br /><br />Иногда требуется сделать клик не по самому изображению, а со смещением. Указывать можно как вначале скрипта так и перед функцией Findimage.
</p>
<pre>set findoffsetx 50    //смещение вправо на 50 пикселей
set findoffsety 30    //смещение вниз на 30 пикселей

set findoffsetx -40   //смещение влево на 40 пикселей
set findoffsety -60   //смещение вверх на 60 пикселей
</pre>
<h2><span id="Примеры"></span><span class="mw-headline" id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80.D1.8B">Примеры</span></h2>
<pre>// Пример 1
// перед запуском скрипта не забываем привязать скрипт к рабочему окну (Ctrl+A)
set #startX 100
set #startY 120
set #endX 300
set #endY 540
set $path "C:\Program Files\UOPilot\images\"
set %cash[1] картинка
// будем искать картинку из файла C:\Program Files\UOPilot\images\картинка.bmp
set #a findimage (#startX #startY #endX #endY ($path%cash[1].bmp) %crds 2)
if #a &gt; 0
  msg Изображение найдено в координатах X= %crds[1 1] Y= %crds[1 2]. Кликнем на нём...
  left %crds[1 1] %crds[1 2] // кликнули
else
  msg Изображение не найдено
end_if
</pre>
<p>В результате работы, если в заданной области картинка обнаружена, в массив %crds[1 1] будет записано значение координаты X
для первой картинки, а в %crds[2 2] - значение Y для второй картинки.
</p>
<pre>// Пример 2
//поиск изображений (если будет найдено больше 20 поиск прекратится) с точностью 70% и отклонением в цвете 5%
set #check FindImage (#startX #startY #endX #endY (images\step.bmp) %crds 2 70 20 5)   
</pre>
<pre>// Пример 3
set #b FindImage (10 100 30 150 (d:\myImages\wolf.bmp) %arr 2 80 20 5)
</pre>
<pre>// Пример 4
// будем искать картинку из файла картинка2.bmp, находящуюся в папке пилота
set #a findimage (100 120 1024 700 (\картинка2.bmp) %arr 2 80 -1)  
set #w size (%arr) // получим число найденных картинок
msg Найдено картинок: #w
for #i 1 #w
   set #x %arr [#i 1]
   set #y %arr [#i 2]
   msg картинка в координатах: #x #y
end_for
</pre>
<pre>// Пример 5
// поиск нескольких картинок
// перед запуском скрипта не забываем привязать скрипт к рабочему окну (Ctrl+A)
set #startX 0
set #startY 0
set #endX 1920
set #endY 1080
set $path "C:\Program Files\UOPilot\images\"      // путь к картинкам
set %image [1] картинка1                          // имя изображения
set %image [2] картинка2                          // имя второго изображения
set %image [3] картинка3                          // третьего
set %image [4] карти                              // имена могут быть любыми

set #size size(%image)                            // всего картинок 
hint Всего картинок #size 

:metka
for #i 1 #size 1                     // цикл для поиска картинок
    set #a findimage (#startX #startY #endX #endY ($path%image[#i].bmp) %arr 2)
    if  #a &gt; 0
        move %arr[1 1] %arr[1 2]     // переместить курсор на найденную картинку
        wait 500                     // ждать 0,5 секунды
    end_if
end_for
wait 3000                            // ждать 3 секунды
goto metka
</pre>
<p><br /><b>Примеры поиска картинки в перекрытом(не свёрнутом) окне:</b>
<br />Привязка к окну обязательна. Aero (темы Windows 7) должен быть включен. Если был установлен Астер, то он должен быть отключен, а система перезагружена.
<br />Окно может быть перекрыто полностью, частично или вообще не перекрыто. Может находиться за пределами экрана.
<br />Иногда требуется указывать родительское окно. В окне пилота есть кнопка 'F', при нажатии открывается окно, в котором отображается что "видит" пилот при поиске (Findcolor, Findimage). Если в окне "чёрный квадрат", значит указано не то окно. В Windows 10 работает не во всех приложениях, может потребоваться установка Aero Glass.
</p>
<pre>// Пример 6
//Чтобы понять как работает поиск можно попробовать на рабочем столе найти значок 'Мой компьютер'.
//Делаем картинку значка в формате bmp, называем 'мойкомпьютер' (без кавычек), закидываем на диск 'C:'.
//При этом можно перекрыть значок каким-нибудь окном.

//Не забываем сделать привязку Ctrl + A.
set #a FindImage(0 0 1920 1080 (C:\мойкомпьютер.bmp) %arr workwindow)
if #a &gt; 0
    log Картинка найдена. Наведём на неё курсор.
    move %arr [1 1] %arr [1 2]
    End_script
else
    msg Картинка не найдена.
end_if 
</pre>
<pre>// Пример 7
//Ищем картинку в окне Yandex, при этом не важно какое указано окно через Ctrl + A или сделано рабочим через 'set workwindow'. 
set #handle FindWindow(Yandex)              //поиск окна с именем Yandex
set #a FindImage(0 0 1920 1080 (C:\UOPilot\images\image.bmp) %arr #handle 80 -1 3)     //поиск изображения
hint #a                                     //в правом нижнем углу отображён результат поиска     
if #a &gt; 0
    move %arr [1 1] %arr [1 2] #handle      //навести курсор на первую найденную картинку 
                                            //обратите внимание, что в команде 'move' указан хендл окна
                                            //т. е. курсор будет перемещён как будто привязка сделана к окну Yandex
    End_script
end_if
</pre>
<h2><span id="Смотрите_также"></span><span class="mw-headline" id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5">Смотрите также</span></h2>
<p><a href="https://uopilot.uokit.com/wiki/index.php?title=Findcolor" title="Findcolor">Findcolor</a>
<br /> <a href="https://uopilot.uokit.com/wiki/index.php?title=If" title="If">If</a>
<br /><a href="https://uopilot.uokit.com/wiki/index.php?title=Get_color" title="Get color">Get color</a>
</p>
<h2><span id="История_развития"></span><span class="mw-headline" id=".D0.98.D1.81.D1.82.D0.BE.D1.80.D0.B8.D1.8F_.D1.80.D0.B0.D0.B7.D0.B2.D0.B8.D1.82.D0.B8.D1.8F">История развития</span></h2>
<p><b>2.20</b>
<br />Добавил команду поиска изображений 'set $a FindImage (StartX StartY EndX EndY (filename) ResultArray [type [accuracy [count]]] [abs])'. Ищет по уникальному для изображения цвету. может ничего не найти, если этот цвет чем-то перекрыт. цвет в левом верхнем углу изображения считается цветом фона, и не анализируется. изображение должно быть 24 бита, bmp. В 'ResultArray' возвращает координаты левого верхнего угла найденых изображений. в строковой переменной возвращает количество найденых изображений, либо процент точности единственного найденного.
<br />type:
<br />1 - надежный (default)
<br />2 - быстрый
<br />accuracy: точность поиска в процентах (default: 80)
<br />count: максимальное количество найденых изображений (default: 1, all: -1)
<br />Коды ошибок:
<br />'-1' упало при поиске, точная причина не известна
<br />'-2' не нашли открывающую скобку после имени функции
<br />'-3' не найдено пути в скобках
<br />'-4' ошибка поиска файла
<br />'-5' ошибка обработки искомого изображения
<br />'-6' ошибка получения изображения с экрана
</p><p><b>2.21.2</b>
<br />Исправил ошибку с определением пути к файлу картинки в 'findimage' после сохранении скрипта через пункт меню 'сохранить как'
</p><p><b>2.23</b>
<br />Добавил в 'findimage' погрешность оттенка. указывается в&#160;%. слегка изменился синтаксис команды:
</p>
<pre>'set $a FindImage (StartX StartY EndX EndY (filename) ResultArray [type [accuracy [count [deviation]]]] [abs])'
</pre>
<p>Пример: есть погрешность 3%. точка имеет цвет 100 120 130, 255*3%=7, соответственно 100+/-7. При этом все цвета в пределах (93 113 123)-(107 127 137) будут считаться совпадением.
<br />Переделал 'findimage'. повысил стабильность работы. ускорил в ~27 раз при типе поиска 2
<br />Исправил вычисление точности найденной картинки в команде 'findimage'
</p><p><b>2.27</b>
<br />Научил 'findimage' искать картинки в перекрытых окнах. ищет не на всем экране, а в конкретном указанном окне. хэндл окна указывается в качестве типа поиска
</p>
<pre>set #w findwindow (test.bmp)
set $a FindImage ( 0 0 1300 1300 (2.bmp) %a workwindow 70 10 15)
set $a FindImage ( 0 0 1300 1300 (2.bmp) %a #w 70 10 15)
</pre>
<p><b>2.27.1</b>
<br />Добавил код ошибки -4 с выводом сообщения, что файл не найден в команде 'findimage'.
<br />Подправил поиск в перекрытых окнах в командах 'findimage', 'findcolor'.
</p><p><b>2.31</b>
<br />Научил 'findimage' понимать координаты, указанные элементами массива.
</p><p><b>2.32</b>
<br />Добавил в 'findimage' возврат конечных координат найденной картинки в третьем и четвертом элементе возвращаемого массива.
</p><p><b>2.33</b>
<br />Исправил ошибку в 'findimage', когда выводил имя массива вместо количества найденных.
<br />Переписал команду 'findimage'. Исправил утечки памяти.
</p><p><b>2.34</b>
<br />Исправил 'findimage' и 'findcolor'. Возвращали неправильные координаты по Y. Ищет слева снизу - вправо вверх.
</p><p><b>2.35</b>
<br />Перевернул 'findimage'. Теперь снова ищет сверху вниз.
<br />Исправил в команде 'findimage' выходом за пределы диапазона поиска в сторону уменьшения.
<br />Добавил в 'findimage' возврат конечных координат найденной картинки в третьем и четвертом элементе возвращаемого массива при типе поиска 2.
<br />Исправил в 'findimage' возврат конечных координат найденной картинки (не возвращало совсем).
<br />Исправил 'findimage' и 'findcolor'. Возвращали неправильные координаты.
<br />Сделал по-умолчанию второй тип поиска в команде 'findimage'.
</p><p><b>2.36</b>
<br />Добавил переменные смещения кликов мышью и команды 'move', и переменные смещения возвращаемых координат команд 'findimage' и 'findcolor':
'clickoffsetx', 'clickoffsety', 'findoffsetx',  'findoffsety'. 
</p>
<pre>  //размер картинки 9х9
set findoffsetx 5 
set findoffsety 5
set ... findimage
  //вернет координаты не левого верхнего угла а центра картинки
</pre>
<pre>set clickoffsetx 5
set clickoffsety 5
left 0 0
  //кликнет в координаты 5, 5
</pre>
<p>Добавил кнопочку "F", открывающую тестовую формочку с изображением, найденным Findimage.
</p><p><b>2.39</b>
<br />Исправил ошибку "-4", возникающую, если координата и путь к файлу не разделены пробелом.
</p><p><b>2.41</b>
<br />В команду 'findimage' добавил код ошибки '-7' - нечего искать, искомая картинка пустая.
</p>





		
		
		
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a  title="Служебная:Категории">Категория</a>: <ul><li><a  class="new" title="Категория:Поиск изображений (страница не существует)">Поиск изображений</a></li></ul>
		
		<div class="visualClear"></div>
		
	</div>
</div>

		
<br>
<div class="printfooter">Источник — <a dir="ltr" href="https://uopilot.uokit.com/wiki/index.php?title=Findimage&amp;oldid=555">https://uopilot.uokit.com/wiki/index.php?title=Findimage&amp;oldid=555</a></div></body>
</html>
 